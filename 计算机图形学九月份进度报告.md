## 《计算机图形学》9月报告

##### 王嘉豪 201220162

**(南京大学 计算机科学与技术系， 南京 210093)**

- **1 引言**

  本实习作业采用助教给出的 `CG_Demo` 作为框架，并在其基础上逐步实现画图和修改图形等算法，最后能够处理输入的命令和UI操作来画出想要的简单图形

- **2.1 已实现内容及思路、算法等**

  - ==DDA算法绘制线段==

    比较简单的画线方法，判断斜率绝对值是否大于1来确定以x或是y作为增量，从而使像素点数量更多

  - ==Bresenham算法绘制线段==

    引入决策参数$p_k$，用于决定选高/低像素点。选择时也要区分斜率大于/小于1的情况，小于1时取$\Delta x = 1$， 反之取$\Delta y = 1$；

    以 $abs(斜率) < 1$ 的情况为例：$p_{k+1} - p_k = 2\Delta y(x_{k+1} - x_k) - 2\Delta x(y_{k+1}-y_k)$，$p_k > 0$ 时 $y_{k+1} = y_k+1$ (取高像素)，$p_{k+1} = p_k + 2\Delta y-2\Delta x$， 否则$y_{k+1} = y_k$(取低像素)，$p_{k+1} = p_k + 2\Delta y$

  - ==中点椭圆生成算法绘制椭圆==

    椭圆函数为 $f_{ellipse}(x, y)={r_y}^2x^2+{r_x}^2y^2-{r_x}^2{r_y}^2$，对于不同的 $(x, y)$ 有以下性质：

    $ \left \{ \begin{aligned} f_{ellipse}(x,y)<0,(x,y)\ 位于椭圆周边界内 \\ f_{ellipse}(x,y)=0,(x,y)\ 位于椭圆周边界上 \\f_{ellipse}(x,y)>0,(x,y)\ 位于椭圆周边界外 \end{aligned} \right.$

    假设椭圆中心位于原点处，$r_x > r_y$，则可将其分为两个区域：切线斜率绝对值小于1(区域一)和大于1(区域二)，理由同上述直线

    第一象限分界点满足 $dy/dx=-1$，即 $2{r_y}^2x = 2{r_x}^2y$，可从 $(0, r_y)$ 处开始以 $\Delta x=1$ 移动直到 $2{r_y}^2x \geq 2{r_x}^2y$ 

    $决策参数\ p1_k=f_{ellipse}(x_{k+1}, y_k-\frac{1}{2})={r_y}^2(x_k+1)^2+{r_x}^2(y_k-\frac{1}{2})^2-{r_x}^2{r_y}^2$ 

    若 $p1_k < 0$，中点在椭圆内，选择高像素点 $y_k$，否则选低像素点 $y_{k-1}$，故下一步决策参数如下：

    $\left \{ \begin{aligned} p1_{k+1}=p1_k+2{r_y}^2x_k+3{r_y}^2,\ \ \ \ \  \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ p1_k<0 \\p1_{k+1} =p1_k+2{r_y}^2x_k-2{r_x}^2y_k+2{r_x}^2+3{r_y}^2, p1_k \geq0\end{aligned} \right.$

    当 $切线斜率<-1$ 时，以上述过程的最后一个点作为新区域的起点 $(x0, y0)$，此时 $\Delta y=1$

    $决策参数p2_k=f_{ellipse}(x_k+\frac{1}{2},y_k-1)={r_y}^2(x_k+\frac{1}{2})^2+{r_x}^2(y_k-1)^2-{r_x}^2{r_y}^2$

    若 $p2_k \leq 0$，中点在椭圆内，选择像素点 $x_{k+1}$，否则选像素点 $x_k$，故下一步决策参数如下(教材上判断条件写反了)：

    $\left \{ \begin{aligned} p2_{k+1}=p2_k-2{r_x}^2y_k+3{r_x}^2,\ \ \ \ \  \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ p2_k>0 \\ p2_{k+1} =p2_k+2{r_y}^2x_k-2{r_x}^2y_k+2{r_y}^2+3{r_x}^2, p2_k \leq0\end{aligned} \right.$

    实现算法时只需区分长短轴分别在 $x/y$ 轴上的情况，在生成一个象限的点后其他象限可对称生成，最后为每个点加上 $(\cfrac{x_0+x_1}{2},\cfrac{y_0+y_1}{2})$ 作为偏移量

  - ==图元平移==

    只需将每个点的横纵坐标依次加上 $\Delta x、\Delta y$ 即可

  - ==图元旋转==

    当基准点为坐标原点时，二维旋转变换方程为：

    $\left \{ \begin{aligned} x_2=x_1cos\theta-y_1sin\theta \\ y_2=x1sin\theta+y_1cos\theta \end{aligned} \right.$

    可先将每个点的坐标减去旋转中心，将基准点变为原点后完成旋转，最后将偏移量加回

    `Python` 的 $sin/cos$ 函数以弧度制作为输入，使用时需将角度转为弧度

  - ==图元缩放==

    缩放中心点到图像各点的坐标差值乘缩放倍数即是新点的坐标，也可以先算出新点对于旧点的偏移量如下

    ~~~
    delta_x = (p_list[i][0] - x) * (s - 1)  #(x, y)为缩放中心，s为缩放倍数
    delta_y = (p_list[i][1] - y) * (s - 1)
    ~~~

    最后为旧点加上偏移量

  - ==Cohen-Sutherland算法裁剪线段==

    以裁剪窗口为中心，加上其周围八个方向的窗口，对这九个窗口采用四位“区域码”，从而确定线段端点的相对位置

    规则如下：

    ~~~ 
                              |                                             |
            1001              |                   1000                      |           1010
            Ymax              |                                             |
    -----------------------------------------------------------------------------------------------------
                              |                                             |
            0001              |       	          0000                      |           0010
            Ymin              |                  window                     |
    -----------------------------------------------------------------------------------------------------
    						  |                                             |
            0101              |                   0100                      |           0110
                              |                                             |
                             Xmin                                          Xmax
    ~~~

    若两端点区域码均为 $0000$，则线段完全处于裁剪窗口内

    若两端点区域码相与之后结果不为 $0000$，则线段完全处于窗口外，舍弃

    其他情况均需要求线段和窗口的交

    仅当两区域码的同一位不相同时，线段才可能在对应边界上存在交点，即：

    $(flag1 \oplus flag2) == 1/2/4/8$ 时，分别在 $x_{min}/x_{max}/y_{min}/y_{max}$ 处求交点，可按照上下右左的顺序检查是否在边界上存在交点，存在交点时更新窗口外部端点的 $(x, y)$，最后留下的部分即为裁剪得到的线段

  - ==Liang-Barsky算法裁剪线段==

    `Liang-Barsky` 算法将二维裁剪转化为一维裁剪，设两端点分别为 $(x_0,y_0),(x_1,y_1)$，则线段上一点 $(x, y)$ 可表示为：

    $\left \{ \begin{aligned} x=x_0+\mu(x_1-x_0)=x_0+\mu \Delta x \\y=y_0+\mu(y_1-y_0)=y_0+\mu\Delta y \ \ \end{aligned} \right.$

    其中 $\mu \in[0,1]$

    要求得在裁剪窗口内的部分，则上式需满足：

    $\left \{ \begin{aligned} x{\omega}_{min}\leq x_0+\mu \Delta x \leq x{\omega}_{max} \\ y{\omega}_{min} \leq y_0+\mu\Delta y\leq y{\omega}_{max} \ \end{aligned} \right.$

    上式可统一表示为 $\mu*p_k \leq q_k$，其中 $k=1,2,3,4$，对应裁剪窗口的左右上下边界，$p、q$ 定义为：

    $\left \{ \begin{aligned} p_1=-\Delta x,q_1=x_0-x{\omega}_{min} \\ p_2=\Delta x,q_2=x{\omega}_{max}-x_1 \ \ \\ p_3=-\Delta y,q_3=y_0-y{\omega}_{min} \\ p_4=\Delta y,q_4=y{\omega}_{max}-y_1 \ \ \ \end{aligned} \right.$

    (教材符号又反了)

    若任意 $p_k=0$，则线段所在直线平行于裁剪窗口之一；若同时 $q_k <0$，则线段完全在边界外，否则在窗口内

    故当 $p_k$ 非零时，可计算线段与边界 $k$ 交点的 $\mu$ 值：$\mu =q_k/p_k$

    对每条线段计算参数 $\mu_1 、\mu_2$，$\mu_1$ 的值由线段从外到内遇到的矩形边界所决定($p<0$)，$\mu_2$ 的值由线段从内到外遇到的矩形边界所决定($p>0$)

    对每个边界计算参数$r_k=q_k/p_k$，$p<0$ 时 $\mu1$ 取 $0$ 和各个 $r_k$ 间的最大值，$\mu_2$ 取 $1$ 和各个 $r_k$ 之间的最小值

    若在任意一次更新后 $\mu_1>\mu_2$，则需要舍弃该线段，否则保留 $\mu_1、\mu_2$ 进行后续计算

    在进行四次更新后若线段仍未被舍弃，则可以用下式求出最终两点坐标：

    ~~~
    if mu2 < 1:
        x1 = x0 + mu2 * delta_x
        y1 = y0 + mu2 * delta_y
    if mu1 > 0:
        x0 = x0 + mu1 * delta_x
        y0 = y0 + mu1 * delta_y
    ~~~

    $(x_0,y_0),(x_1,y_1)$ 为截取后线段端点坐标

    `Liang-Barsky` 算法相比 `Cohen-Sutherland` 算法效率更高，因为只在计算 $\mu_1、\mu_2$ 时使用除法

  - ==对输入命令的处理==

    在原有基础上新增对 `drawPolygon/Ellipse/Curve translate/rotate/scale/clip` 命令的处理，即将输入的 `string` 分割后提取参数并调用 `cg_algorithms.py` 中的函数绘图

  - ==交互界面不定参数数量的处理方法==

    矩形、曲线的绘制会涉及到不确定数量点的输入，我采用识别鼠标双击事件来确定最后一个点（即画最后一个点时需双击鼠标）

    由于`pyqt`会在识别一次 `mouseDoubleClick` 事件时同时触发两次 `mousePressEvent` 和`mouseReleaseEvent`，所以需删去参数列表中的最后一个参数，即：

    ~~~
    del(self.temp_item.p_list[-1])
    ~~~

    从而使得参数不会重复/冗余

- **2.2 尚未实现内容**

  - 曲线绘制
  - 大部分的GUI交互内容，如画笔颜色、手动变换图形等
  - 可自己实现的更多功能
  - ...

- **3 联系方式**

  QQ：514121890

  邮箱：514121890@qq.com  或   201220162@smail.nju.edu.cn

- **4 参考资料**

  孙正兴，周良等《计算机图形学教程》，机械工业出版社，2008

- **5 结束语**

  ...